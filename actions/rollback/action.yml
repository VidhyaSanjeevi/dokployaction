---
name: 'Rollback Deployment'
description: 'Rollback Dokploy application to previous version'
author: 'Dokploy Actions'

branding:
  icon: 'rotate-ccw'
  color: 'orange'

inputs:
  dokploy-url:
    description: 'Dokploy instance URL'
    required: true
  api-key:
    description: 'Dokploy API key'
    required: true
  application-id:
    description: 'Application ID to rollback'
    required: true
  wait-for-completion:
    description: 'Wait for rollback to complete'
    required: false
    default: 'true'
  timeout:
    description: 'Rollback timeout in seconds'
    required: false
    default: '300'

outputs:
  rollback-status:
    description: 'Rollback status'
    value: ${{ steps.rollback.outputs.status }}

runs:
  using: 'composite'
  steps:
    - name: Initiate rollback
      id: rollback
      shell: bash
      run: |
        echo "ðŸ”„ Initiating rollback..."
        echo "Application ID: ${{ inputs.application-id }}"

        response=$(curl -s -w "\n%{http_code}" -X POST \
          "${{ inputs.dokploy-url }}/api/application.rollback" \
          -H "x-api-key: ${{ inputs.api-key }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"applicationId\": \"${{ inputs.application-id }}\"
          }")

        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | sed '$d')

        if [[ "$http_code" -ge 200 && "$http_code" -lt 300 ]]; then
          echo "âœ… Rollback initiated successfully"
          echo "status=initiated" >> $GITHUB_OUTPUT
        else
          echo "âŒ Rollback failed with HTTP $http_code"
          echo "Response: $body"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Wait for rollback
      if: inputs.wait-for-completion == 'true'
      shell: bash
      run: |
        echo "â³ Waiting for rollback to complete..."

        timeout=${{ inputs.timeout }}
        elapsed=0
        interval=10

        while [ $elapsed -lt $timeout ]; do
          response=$(curl -s -X GET \
            "${{ inputs.dokploy-url }}/api/application.one?applicationId=${{ inputs.application-id }}" \
            -H "x-api-key: ${{ inputs.api-key }}")

          status=$(echo "$response" | jq -r '.applicationStatus // "unknown"')

          echo "Status: $status (${elapsed}s elapsed)"

          if [[ "$status" == "done" || "$status" == "running" ]]; then
            echo "âœ… Rollback completed successfully"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          elif [[ "$status" == "error" || "$status" == "failed" ]]; then
            echo "âŒ Rollback failed"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          sleep $interval
          elapsed=$((elapsed + interval))
        done

        echo "âš ï¸ Rollback timeout after ${timeout}s"
        echo "status=timeout" >> $GITHUB_OUTPUT
        exit 1

    - name: Verify rollback
      if: success()
      shell: bash
      run: |
        echo "ðŸ” Verifying rollback..."

        response=$(curl -s -X GET \
          "${{ inputs.dokploy-url }}/api/application.one?applicationId=${{ inputs.application-id }}" \
          -H "x-api-key: ${{ inputs.api-key }}")

        current_version=$(echo "$response" | jq -r '.currentVersion // "unknown"')
        echo "Current version: $current_version"
        echo "âœ… Rollback verified"

    - name: Rollback summary
      if: always()
      shell: bash
      run: |
        echo "## ðŸ”„ Rollback Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Application ID**: ${{ inputs.application-id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ steps.rollback.outputs.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
