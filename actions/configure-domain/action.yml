---
name: 'Configure Domain'
description: 'Configure domain for Dokploy application'
author: 'Dokploy Actions'

branding:
  icon: 'globe'
  color: 'blue'

inputs:
  dokploy-url:
    description: 'Dokploy instance URL'
    required: true
  api-key:
    description: 'Dokploy API key'
    required: true
  application-id:
    description: 'Application ID'
    required: true
  domain-host:
    description: 'Domain host (e.g., api.example.com)'
    required: true
  port:
    description: 'Application port'
    required: false
    default: '80'
  https:
    description: 'Enable HTTPS'
    required: false
    default: 'true'
  path:
    description: 'Path prefix (e.g., /api)'
    required: false
    default: '/'
  health-check-path:
    description: 'Health check endpoint path (e.g., /health or /). If provided, performs health check after domain creation.'
    required: false
    default: ''
  health-check-retries:
    description: 'Number of health check retries'
    required: false
    default: '10'
  health-check-interval:
    description: 'Interval between health check retries in seconds'
    required: false
    default: '5'

outputs:
  domain-id:
    description: 'Created domain ID'
    value: ${{ steps.create.outputs.domain-id }}
  domain-url:
    description: 'Full domain URL'
    value: ${{ steps.create.outputs.domain-url }}

runs:
  using: 'composite'
  steps:
    - name: Validate domain
      shell: bash
      run: |
        domain="${{ inputs.domain-host }}"

        if [[ ! "$domain" =~ ^[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]?\.[a-zA-Z]{2,}$ ]]; then
          echo "âš ï¸ Warning: Domain format may be invalid: $domain"
        fi

        echo "âœ… Domain validated: $domain"

    - name: Create domain
      id: create
      shell: bash
      run: |
        echo "ðŸŒ Configuring domain..."
        echo "Host: ${{ inputs.domain-host }}"
        echo "Port: ${{ inputs.port }}"
        echo "HTTPS: ${{ inputs.https }}"
        echo "Path: ${{ inputs.path }}"

        response=$(curl -s -w "\n%{http_code}" -L -X POST \
          "${{ inputs.dokploy-url }}/api/domain.create" \
          -H "x-api-key: ${{ inputs.api-key }}" \
          -H "Content-Type: application/json" \
          -H "Accept: application/json" \
          -d "{
            \"applicationId\": \"${{ inputs.application-id }}\",
            \"host\": \"${{ inputs.domain-host }}\",
            \"port\": ${{ inputs.port }},
            \"https\": ${{ inputs.https }},
            \"path\": \"${{ inputs.path }}\",
            \"certificateType\": \"letsencrypt\",
            \"domainType\": \"application\",
            \"stripPath\": false
          }")

        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | sed '$d')

        if [[ "$http_code" -ge 200 && "$http_code" -lt 300 ]]; then
          echo "âœ… Domain configured successfully"

          domain_id=$(echo "$body" | jq -r '.domainId // .id // "unknown"')
          echo "domain-id=$domain_id" >> $GITHUB_OUTPUT
          echo "Domain ID: $domain_id"

          protocol="http"
          if [ "${{ inputs.https }}" = "true" ]; then
            protocol="https"
          fi

          domain_url="${protocol}://${{ inputs.domain-host }}${{ inputs.path }}"
          echo "domain-url=$domain_url" >> $GITHUB_OUTPUT
          echo "Domain URL: $domain_url"
        else
          echo "âŒ Failed to configure domain (HTTP $http_code)"
          echo "Response: $body"
          exit 1
        fi

    - name: Verify domain
      shell: bash
      run: |
        echo "ðŸ” Verifying domain configuration..."

        response=$(curl -s -w "\n%{http_code}" -L -X GET \
          "${{ inputs.dokploy-url }}/api/domain.one?domainId=${{ steps.create.outputs.domain-id }}" \
          -H "x-api-key: ${{ inputs.api-key }}" \
          -H "Accept: application/json")

        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | sed '$d')

        if [[ "$http_code" -ge 200 && "$http_code" -lt 300 ]]; then
          host=$(echo "$body" | jq -r '.host // .data.host // "unknown"')

          if [ "$host" = "${{ inputs.domain-host }}" ]; then
            echo "âœ… Domain verified: $host"
          else
            echo "âš ï¸ Domain verification warning: expected ${{ inputs.domain-host }}, got $host"
          fi
        else
          echo "âš ï¸ Domain verification failed (HTTP $http_code), but domain was created successfully"
          echo "Domain ID: ${{ steps.create.outputs.domain-id }}"
        fi

    - name: Health check domain
      if: inputs.health-check-path != ''
      shell: bash
      run: |
        HEALTH_URL="${{ steps.create.outputs.domain-url }}${{ inputs.health-check-path }}"
        # Remove duplicate slashes if health-check-path starts with /
        HEALTH_URL=$(echo "$HEALTH_URL" | sed 's#//#/#g' | sed 's#:/#://#')

        echo "ðŸ¥ Checking health of domain: $HEALTH_URL"
        echo "Retries: ${{ inputs.health-check-retries }}"
        echo "Interval: ${{ inputs.health-check-interval }}s"

        # Wait for SSL certificate and routing to be ready
        echo "â³ Waiting 10s for SSL certificate provisioning..."
        sleep 10

        for i in $(seq 1 ${{ inputs.health-check-retries }}); do
          echo "Attempt $i/${{ inputs.health-check-retries }}..."
          response=$(curl -s -o /dev/null -w "%{http_code}" -L "$HEALTH_URL" 2>/dev/null || echo "000")

          if [ "$response" = "200" ]; then
            echo "âœ… Domain is healthy! (HTTP 200)"
            exit 0
          fi

          echo "âš ï¸ Health check returned HTTP $response, retrying in ${{ inputs.health-check-interval }}s..."
          sleep ${{ inputs.health-check-interval }}
        done

        echo "âš ï¸ Health check did not pass within timeout, but domain was configured successfully"
        echo "Please verify manually: $HEALTH_URL"

    - name: Domain summary
      if: always()
      shell: bash
      run: |
        echo "## ðŸŒ Domain Configuration Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Domain**: ${{ inputs.domain-host }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Domain ID**: ${{ steps.create.outputs.domain-id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: ${{ steps.create.outputs.domain-url }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Port**: ${{ inputs.port }}" >> $GITHUB_STEP_SUMMARY
        echo "- **HTTPS**: ${{ inputs.https }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Path**: ${{ inputs.path }}" >> $GITHUB_STEP_SUMMARY
