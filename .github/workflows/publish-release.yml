name: Publish Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate version format
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi

          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            echo "Expected format: v1.0.0"
            exit 1
          fi

          echo "‚úÖ Version format valid: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build action
        run: npm run build

      - name: Verify dist is up to date
        run: |
          # Check if dist/ has changes (excluding source maps which have absolute paths)
          CHANGES=$(git status --porcelain dist/ | grep -v '\.map$' || true)
          if [ -n "$CHANGES" ]; then
            echo "‚ùå dist/ is out of date. Run 'npm run build' and commit the changes."
            git diff dist/ -- ':!*.map'
            exit 1
          fi
          echo "‚úÖ dist/ is up to date (source maps excluded from check)"

      - name: Validate action.yml for Marketplace
        run: |
          echo "üîç Validating action.yml for GitHub Marketplace..."

          # Check required fields exist
          if ! grep -q "^name:" action.yml; then
            echo "‚ùå Missing 'name' field in action.yml"
            exit 1
          fi

          if ! grep -q "^description:" action.yml; then
            echo "‚ùå Missing 'description' field in action.yml"
            exit 1
          fi

          if ! grep -q "^author:" action.yml; then
            echo "‚ùå Missing 'author' field in action.yml"
            exit 1
          fi

          if ! grep -q "^branding:" action.yml; then
            echo "‚ùå Missing 'branding' field in action.yml"
            exit 1
          fi

          # Check description length (must be < 125 characters)
          DESCRIPTION=$(grep "^description:" action.yml | sed 's/description: *//' | tr -d "'\"")
          DESC_LENGTH=${#DESCRIPTION}

          if [ $DESC_LENGTH -ge 125 ]; then
            echo "‚ùå Description is too long: $DESC_LENGTH characters (must be < 125)"
            echo "Description: $DESCRIPTION"
            exit 1
          fi

          echo "‚úÖ action.yml is valid for GitHub Marketplace"
          echo "   - Description length: $DESC_LENGTH characters"

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: notes
        run: |
          cat > release-notes.md << 'EOF'
          ## üöÄ Dokploy GitHub Actions - ${{ steps.version.outputs.version }}

          [![GitHub Marketplace](https://img.shields.io/badge/Marketplace-Dokploy%20Deployment%20Suite-blue.svg?colorA=24292e&colorB=0366d6&style=flat&longCache=true&logo=github)](https://github.com/marketplace/actions/dokploy-deployment-suite)

          This action is now available on **GitHub Marketplace**! üéâ

          ### üì¶ Available Actions

          - **Main Action**: `SSanjeevi/dokployaction@${{ steps.version.outputs.version }}`
          - **Deploy**: `SSanjeevi/dokployaction/actions/deploy@${{ steps.version.outputs.version }}`
          - **Health Check**: `SSanjeevi/dokployaction/actions/health-check@${{ steps.version.outputs.version }}`
          - **Cleanup Containers**: `SSanjeevi/dokployaction/actions/cleanup-containers@${{ steps.version.outputs.version }}`
          - **Rollback**: `SSanjeevi/dokployaction/actions/rollback@${{ steps.version.outputs.version }}`
          - **Setup SSL**: `SSanjeevi/dokployaction/actions/setup-ssl@${{ steps.version.outputs.version }}`
          - **Configure Domain**: `SSanjeevi/dokployaction/actions/configure-domain@${{ steps.version.outputs.version }}`

          ### üìö Documentation

          - [Quick Start Guide](https://github.com/SSanjeevi/dokployaction/blob/main/QUICK_START.md)
          - [Examples](https://github.com/SSanjeevi/dokployaction/tree/main/examples)
          - [API Reference](https://github.com/SSanjeevi/dokployaction/blob/main/docs/API_REFERENCE.md)
          - [Contributing Guide](https://github.com/SSanjeevi/dokployaction/blob/main/CONTRIBUTING.md)

          ### üîß Quick Start

          ```yaml
          - name: Deploy to Dokploy
            uses: SSanjeevi/dokployaction@${{ steps.version.outputs.version }}
            with:
              dokploy-url: ${{ secrets.DOKPLOY_URL }}
              api-key: ${{ secrets.DOKPLOY_API_KEY }}
              application-id: 'your-app-id'
              docker-image: 'ghcr.io/user/app:latest'
          ```

          ### ‚ú® Key Features

          - üöÄ **Zero-downtime deployments** with health checks
          - üîÑ **Automatic rollback** on deployment failure
          - üè• **Health monitoring** with configurable retry logic
          - üßπ **Container cleanup** to manage resources
          - üîí **SSL/TLS setup** for secure connections
          - üåê **Domain configuration** automation
          - üìä **Comprehensive logging** and GitHub step summaries

          ### üìã What's Changed

          See [CHANGELOG.md](https://github.com/SSanjeevi/dokployaction/blob/main/CHANGELOG.md) for detailed changes.

          ### üôè Support

          If you find this action helpful, please ‚≠ê star the repository and share it with others!
          EOF

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to GitHub Marketplace
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          echo "üì¶ Publishing to GitHub Marketplace..."
          echo ""
          echo "‚ö†Ô∏è  IMPORTANT: For the first release, you need to manually enable Marketplace publication:"
          echo ""
          echo "1. Go to: https://github.com/${{ github.repository }}/releases/tag/$VERSION"
          echo "2. Click 'Edit' on the release"
          echo "3. Check the box: ‚òëÔ∏è  'Publish this Action to the GitHub Marketplace'"
          echo "4. Click 'Update release'"
          echo ""
          echo "After the first release, subsequent releases will automatically publish to Marketplace."
          echo ""
          echo "‚úÖ Release created successfully!"

      - name: Marketplace publication summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          echo "## üéâ Release Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Release $VERSION has been created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### üì¶ GitHub Marketplace Publication" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è **MANUAL STEP REQUIRED** (First Release Only)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To publish this action to GitHub Marketplace:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to the [Release Page](https://github.com/${{ github.repository }}/releases/tag/$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "2. Click the **Edit** button" >> $GITHUB_STEP_SUMMARY
          echo "3. Check the box: ‚òëÔ∏è **Publish this Action to the GitHub Marketplace**" >> $GITHUB_STEP_SUMMARY
          echo "4. Click **Update release**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note**: After the first release is published to Marketplace, subsequent releases will automatically appear there." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### üîó Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- üìù [Edit Release](https://github.com/${{ github.repository }}/releases/edit/$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "- üè™ [Marketplace Listing](https://github.com/marketplace/actions/dokploy-deployment-suite)" >> $GITHUB_STEP_SUMMARY
          echo "- üì¶ [All Releases](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
          echo "- üè† [Repository](https://github.com/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY

  update-major-tag:
    name: Update Major Version Tag
    runs-on: ubuntu-latest
    needs: create-release
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update major version tag
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          
          # Extract major version (e.g., v1.2.3 -> v1)
          MAJOR_VERSION=$(echo $VERSION | cut -d. -f1)
          
          echo "Creating/updating major version tag: $MAJOR_VERSION"
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Force update the major version tag
          git tag -fa $MAJOR_VERSION -m "Update $MAJOR_VERSION to $VERSION"
          git push origin $MAJOR_VERSION --force
          
          echo "‚úÖ Updated $MAJOR_VERSION tag to point to $VERSION"
